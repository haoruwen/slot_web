<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Result</title>
  <!-- È¢ÑÂä†ËΩΩÂÖ≥ÈîÆÂõæÁâá -->
  <link rel="preload" as="image" href="{{ url_for('static', filename='background/board.png') }}">
  <style>
    html {
        overflow: hidden;
        height: 100%;
    }
    
    body { 
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
        margin: 0; 
        padding: 0; 
        background-color: #fafafa; 
        background-image: url('../static/background/board.png');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        background-attachment: fixed;
        height: 100vh;
        overflow: hidden;
        position: relative;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: 
            radial-gradient(circle at 20% 30%, rgba(220, 53, 69, 0.04) 0%, transparent 50%),
            radial-gradient(circle at 80% 70%, rgba(40, 167, 69, 0.04) 0%, transparent 50%),
            radial-gradient(circle at 50% 50%, rgba(255, 215, 0, 0.02) 0%, transparent 60%);
        pointer-events: none;
        z-index: 0;
        animation: shimmer 10s ease-in-out infinite;
    }
    
    @keyframes shimmer {
        0%, 100% {
            opacity: 0.4;
        }
        50% {
            opacity: 0.8;
        }
    }
    
    .card { 
        display: inline-block; 
        background: transparent;
        backdrop-filter: none;
        padding: clamp(1.5rem, 4vw, 2.5rem) clamp(1.5rem, 5vw, 4rem); 
        border-radius: 0; 
        box-shadow: none;
        border: none;
        position: relative;
        z-index: 1;
        max-width: min(95vw, 1200px);
        width: 100%;
        box-sizing: border-box;
    }
    
    h1 { 
        margin: 0 0 clamp(0.75rem, 2vw, 1.25rem); 
        font-size: clamp(1.25rem, 3vw, 1.75rem); 
        color: #ffd700; 
        text-shadow: 
            0 0 10px rgba(255, 215, 0, 0.8),
            0 2px 4px rgba(0, 0, 0, 0.5);
        text-align: center;
    }
    
    .prize { 
        font-size: clamp(1.5rem, 3.5vw, 2.5rem); 
        color: #ffd700; 
        font-weight: 700; 
        margin-bottom: clamp(0.75rem, 2vw, 1.25rem);
        text-shadow: 
            0 0 15px rgba(255, 215, 0, 0.9),
            0 0 25px rgba(255, 193, 7, 0.7),
            0 2px 6px rgba(0, 0, 0, 0.6);
        text-align: center;
        word-wrap: break-word;
    }
    
    .congratulations-text {
        text-align: center;
        margin-bottom: clamp(1rem, 2vw, 1.5rem);
        opacity: 1;
        transform: translateY(0);
        transition: all 0.5s ease;
    }
    
    .congratulations-text.show {
        opacity: 1;
        transform: translateY(0);
    }
    
    .congratulations-text h2 {
        font-size: clamp(1.25rem, 3vw, 2.25rem);
        color: #ffd700;
        font-weight: 800;
        margin: 0 0 clamp(0.5rem, 1vw, 0.75rem);
        text-shadow: 
            0 0 15px rgba(255, 215, 0, 0.9),
            0 0 25px rgba(255, 193, 7, 0.7),
            0 2px 6px rgba(0, 0, 0, 0.6),
            0 1px 2px rgba(0, 0, 0, 0.8);
        letter-spacing: 0.1em;
        animation: textPulse 2s ease-in-out infinite;
        text-align: center;
    }
    
    @keyframes textPulse {
        0%, 100% {
            opacity: 1;
            transform: scale(1);
        }
        50% {
            opacity: 0.8;
            transform: scale(1.02);
        }
    }
    
    .congratulations-text .prize-name {
        font-size: clamp(1rem, 2.5vw, 1.75rem);
        color: #fff8dc;
        font-weight: 600;
        text-shadow: 
            0 0 10px rgba(255, 215, 0, 0.8),
            0 2px 4px rgba(0, 0, 0, 0.6);
        letter-spacing: 0.05em;
        text-align: center;
        word-wrap: break-word;
        padding: 0 clamp(0.5rem, 2vw, 1rem);
    }
    
    .congratulations-text .finding-text {
        font-size: clamp(1.25rem, 3vw, 2.25rem);
        color: #ffd700;
        font-weight: 800;
        margin: 0;
        text-shadow: 
            0 0 15px rgba(255, 215, 0, 0.9),
            0 0 25px rgba(255, 193, 7, 0.7),
            0 2px 6px rgba(0, 0, 0, 0.6),
            0 1px 2px rgba(0, 0, 0, 0.8);
        letter-spacing: 0.1em;
        animation: textPulse 2s ease-in-out infinite;
        text-align: center;
        padding: 0 clamp(0.5rem, 2vw, 1rem);
    }
    
    .prize-carousel {
        width: clamp(200px, 35vw, 400px);
        height: clamp(200px, 35vw, 400px);
        aspect-ratio: 1;
        margin: 0 auto clamp(0.75rem, 2vw, 1.5rem);
        position: relative;
        overflow: visible;
        border-radius: 0;
        border: none;
        box-shadow: none;
        background: transparent;
        transition: all 0.1s ease;
        max-width: 90vw;
        max-height: 90vw;
    }
    
    .prize-carousel-item.winner {
        opacity: 1 !important;
    }
    
    .prize-carousel-item.winner img {
        filter: 
            drop-shadow(0 0 20px rgba(255, 215, 0, 0.9))
            drop-shadow(0 0 35px rgba(255, 215, 0, 0.7))
            drop-shadow(0 0 50px rgba(255, 215, 0, 0.5))
            drop-shadow(0 4px 15px rgba(0, 0, 0, 0.4));
        animation: winnerGlow 1.5s ease-in-out infinite;
    }
    
    @keyframes winnerGlow {
        0%, 100% {
            filter: 
                drop-shadow(0 0 20px rgba(255, 215, 0, 0.9))
                drop-shadow(0 0 35px rgba(255, 215, 0, 0.7))
                drop-shadow(0 0 50px rgba(255, 215, 0, 0.5))
                drop-shadow(0 4px 15px rgba(0, 0, 0, 0.4));
        }
        50% {
            filter: 
                drop-shadow(0 0 30px rgba(255, 215, 0, 1))
                drop-shadow(0 0 50px rgba(255, 215, 0, 0.9))
                drop-shadow(0 0 70px rgba(255, 215, 0, 0.7))
                drop-shadow(0 4px 15px rgba(0, 0, 0, 0.4));
        }
    }
    
    /* ÂΩ©Â∏¶ÊïàÊûú */
    .confetti-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1000;
        overflow: hidden;
    }
    
    .confetti {
        position: absolute;
        width: clamp(12px, 1.2vw, 18px);
        height: clamp(12px, 1.2vw, 18px);
        background: #ffd700;
        top: -20px;
        animation: confettiFall linear forwards;
    }
    
    .confetti:nth-child(1) { left: 5%; background: #ffd700; animation-duration: 4s; animation-delay: 0s; }
    .confetti:nth-child(2) { left: 12%; background: #ff6b6b; animation-duration: 4.2s; animation-delay: 0.1s; }
    .confetti:nth-child(3) { left: 18%; background: #4ecdc4; animation-duration: 3.8s; animation-delay: 0.2s; }
    .confetti:nth-child(4) { left: 25%; background: #ffd700; animation-duration: 4.5s; animation-delay: 0s; }
    .confetti:nth-child(5) { left: 32%; background: #ff6b6b; animation-duration: 4.1s; animation-delay: 0.15s; }
    .confetti:nth-child(6) { left: 38%; background: #4ecdc4; animation-duration: 3.9s; animation-delay: 0.25s; }
    .confetti:nth-child(7) { left: 45%; background: #ffd700; animation-duration: 4.3s; animation-delay: 0.05s; }
    .confetti:nth-child(8) { left: 52%; background: #ff6b6b; animation-duration: 4.4s; animation-delay: 0.2s; }
    .confetti:nth-child(9) { left: 58%; background: #4ecdc4; animation-duration: 4s; animation-delay: 0.1s; }
    .confetti:nth-child(10) { left: 65%; background: #ffd700; animation-duration: 4.2s; animation-delay: 0.3s; }
    .confetti:nth-child(11) { left: 72%; background: #ff6b6b; animation-duration: 3.7s; animation-delay: 0.05s; }
    .confetti:nth-child(12) { left: 78%; background: #4ecdc4; animation-duration: 4.3s; animation-delay: 0.15s; }
    .confetti:nth-child(13) { left: 85%; background: #ffd700; animation-duration: 4.1s; animation-delay: 0.25s; }
    .confetti:nth-child(14) { left: 92%; background: #ff6b6b; animation-duration: 3.9s; animation-delay: 0.1s; }
    .confetti:nth-child(15) { left: 8%; background: #4ecdc4; animation-duration: 4.4s; animation-delay: 0.2s; }
    .confetti:nth-child(16) { left: 22%; background: #ffd700; animation-duration: 3.8s; animation-delay: 0.3s; }
    .confetti:nth-child(17) { left: 35%; background: #ff6b6b; animation-duration: 4.2s; animation-delay: 0.05s; }
    .confetti:nth-child(18) { left: 48%; background: #4ecdc4; animation-duration: 4.1s; animation-delay: 0.15s; }
    .confetti:nth-child(19) { left: 62%; background: #ffd700; animation-duration: 3.9s; animation-delay: 0.25s; }
    .confetti:nth-child(20) { left: 75%; background: #ff6b6b; animation-duration: 4.3s; animation-delay: 0.1s; }
    .confetti:nth-child(21) { left: 88%; background: #4ecdc4; animation-duration: 4s; animation-delay: 0.2s; }
    .confetti:nth-child(22) { left: 15%; background: #ffd700; animation-duration: 4.4s; animation-delay: 0.05s; }
    .confetti:nth-child(23) { left: 42%; background: #ff6b6b; animation-duration: 3.8s; animation-delay: 0.3s; }
    .confetti:nth-child(24) { left: 68%; background: #4ecdc4; animation-duration: 4.2s; animation-delay: 0.15s; }
    
    @keyframes confettiFall {
        0% {
            transform: translateY(0) translateX(0) rotate(0deg) scale(1);
            opacity: 1;
        }
        50% {
            opacity: 1;
        }
        100% {
            transform: translateY(100vh) translateX(calc(var(--drift) * 150px)) rotate(720deg) scale(0.8);
            opacity: 0.3;
        }
    }
    
    .confetti:nth-child(odd) {
        --drift: 1;
        border-radius: 50%;
    }
    
    .confetti:nth-child(even) {
        --drift: -1;
        transform: rotate(45deg);
    }
    
    /* Â¢ûÂº∫ÂΩ©Â∏¶È¢úËâ≤‰∫ÆÂ∫¶ */
    .confetti[style*="#ffd700"],
    .confetti[style*="background: #ffd700"] {
        background: #ffed4e !important;
    }
    
    .confetti[style*="#ff6b6b"],
    .confetti[style*="background: #ff6b6b"] {
        background: #ff8787 !important;
    }
    
    .confetti[style*="#4ecdc4"],
    .confetti[style*="background: #4ecdc4"] {
        background: #6dd5ce !important;
    }
    
    .prize-carousel-container {
        position: relative;
        width: 100%;
        height: 100%;
    }
    
    .prize-carousel-item {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        box-sizing: border-box;
        opacity: 0;
        transition: opacity 0.15s ease-in-out;
        border: none;
        background: transparent;
    }
    
    .prize-carousel-item.active {
        opacity: 1;
    }
    
    .prize-carousel-item img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        filter: drop-shadow(0 4px 15px rgba(0, 0, 0, 0.4));
        border: none;
        outline: none;
        box-shadow: none;
    }
    
    .buttons { 
        margin-top: clamp(1rem, 2vw, 1.5rem);
        text-align: center;
    }
    
    a.button { 
        display: inline-block; 
        margin: clamp(0.25rem, 1vw, 0.5rem); 
        padding: clamp(0.75rem, 2vw, 1.1rem) clamp(1.25rem, 3vw, 2rem); 
        background: rgba(220, 53, 69, 0.85);
        border: clamp(2px, 0.3vw, 3px) solid rgba(255, 215, 0, 0.6);
        color: white; 
        text-decoration: none; 
        border-radius: clamp(0.5rem, 1vw, 0.75rem);
        font-weight: 600;
        font-size: clamp(0.875rem, 2vw, 1.1rem);
        transition: all 0.3s ease;
        box-shadow: 
            0 4px 15px rgba(0, 0, 0, 0.3),
            0 0 20px rgba(255, 215, 0, 0.2);
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        min-width: clamp(120px, 25vw, 180px);
        text-align: center;
    }
    
    a.button:hover { 
        background: rgba(220, 53, 69, 0.95);
        border-color: rgba(255, 215, 0, 0.9);
        transform: translateY(-2px);
        box-shadow: 
            0 6px 20px rgba(0, 0, 0, 0.4),
            0 0 30px rgba(255, 215, 0, 0.4);
    }
    
    /* ÂìçÂ∫îÂºèËÆæËÆ° - ÁßªÂä®ËÆæÂ§á */
    @media (max-width: 768px) {
        body {
            padding: clamp(1rem, 3vw, 2rem);
        }
        
        .card {
            padding: clamp(1.25rem, 4vw, 2rem) clamp(1rem, 3vw, 1.5rem);
        }
        
        .congratulations-text h2,
        .congratulations-text .finding-text {
            font-size: clamp(1.1rem, 4vw, 1.75rem);
        }
        
        .congratulations-text .prize-name {
            font-size: clamp(0.9rem, 3vw, 1.4rem);
        }
        
        .prize-carousel {
            width: clamp(180px, 50vw, 300px);
            height: clamp(180px, 50vw, 300px);
        }
        
        a.button {
            font-size: clamp(0.8rem, 3vw, 1rem);
            padding: clamp(0.65rem, 2.5vw, 0.9rem) clamp(1rem, 3vw, 1.5rem);
            margin: clamp(0.25rem, 1vw, 0.4rem);
        }
    }
    
    /* ÂìçÂ∫îÂºèËÆæËÆ° - Â∞èÂ±èÂπïËÆæÂ§á */
    @media (max-width: 480px) {
        body {
            padding: clamp(0.75rem, 2vw, 1.5rem);
        }
        
        .card {
            padding: clamp(1rem, 4vw, 1.5rem) clamp(0.75rem, 3vw, 1.25rem);
        }
        
        h1 {
            font-size: clamp(1rem, 4vw, 1.5rem);
            margin-bottom: clamp(0.5rem, 2vw, 1rem);
        }
        
        .congratulations-text {
            margin-bottom: clamp(0.75rem, 2vw, 1.25rem);
        }
        
        .congratulations-text h2,
        .congratulations-text .finding-text {
            font-size: clamp(1rem, 4.5vw, 1.5rem);
            margin-bottom: clamp(0.4rem, 1.5vw, 0.6rem);
        }
        
        .congratulations-text .prize-name {
            font-size: clamp(0.85rem, 3.5vw, 1.2rem);
        }
        
        .prize-carousel {
            width: clamp(150px, 60vw, 250px);
            height: clamp(150px, 60vw, 250px);
            margin-bottom: clamp(0.75rem, 2vw, 1.25rem);
        }
        
        .prize {
            font-size: clamp(1.25rem, 4vw, 2rem);
        }
        
        .buttons {
            margin-top: clamp(0.75rem, 2vw, 1.25rem);
        }
        
        a.button {
            font-size: clamp(0.75rem, 3.5vw, 0.95rem);
            padding: clamp(0.6rem, 3vw, 0.85rem) clamp(0.9rem, 4vw, 1.25rem);
            margin: clamp(0.2rem, 1vw, 0.35rem);
            min-width: clamp(100px, 40vw, 150px);
            display: block;
            width: auto;
            max-width: 90%;
            margin-left: auto;
            margin-right: auto;
        }
    }
    
    /* ÂìçÂ∫îÂºèËÆæËÆ° - Âπ≥ÊùøËÆæÂ§á */
    @media (min-width: 769px) and (max-width: 1024px) {
        .prize-carousel {
            width: clamp(280px, 40vw, 350px);
            height: clamp(280px, 40vw, 350px);
        }
        
        .congratulations-text h2,
        .congratulations-text .finding-text {
            font-size: clamp(1.5rem, 3.5vw, 2rem);
        }
    }
    
    /* ÂìçÂ∫îÂºèËÆæËÆ° - Â§ßÂ±èÂπïËÆæÂ§á */
    @media (min-width: 1200px) {
        .card {
            padding: clamp(2rem, 4vw, 3rem) clamp(2.5rem, 5vw, 4.5rem);
        }
        
        .congratulations-text h2,
        .congratulations-text .finding-text {
            font-size: clamp(1.75rem, 3.5vw, 2.5rem);
        }
        
        .congratulations-text .prize-name {
            font-size: clamp(1.25rem, 3vw, 1.9rem);
        }
        
        .prize-carousel {
            width: clamp(320px, 30vw, 450px);
            height: clamp(320px, 30vw, 450px);
        }
        
        a.button {
            font-size: clamp(1rem, 2vw, 1.25rem);
            padding: clamp(1rem, 2vw, 1.25rem) clamp(1.75rem, 3vw, 2.5rem);
        }
    }
    
    /* ÂìçÂ∫îÂºèËÆæËÆ° - Ë∂ÖÂ§ßÂ±èÂπïËÆæÂ§á (2560px+) */
    @media (min-width: 2560px) {
        .card {
            padding: clamp(2.75rem, 5.5vw, 4.5rem) clamp(3.5rem, 6.5vw, 6.5rem);
            max-width: min(90vw, 1500px);
        }
        
        h1 {
            font-size: clamp(1.6rem, 3.8vw, 2.2rem);
        }
        
        .congratulations-text h2,
        .congratulations-text .finding-text {
            font-size: clamp(2.2rem, 4.5vw, 3.3rem);
        }
        
        .congratulations-text .prize-name {
            font-size: clamp(1.6rem, 4vw, 2.5rem);
        }
        
        .prize-carousel {
            width: clamp(450px, 28vw, 600px);
            height: clamp(450px, 28vw, 600px);
        }
        
        .prize {
            font-size: clamp(2.2rem, 4.5vw, 3.3rem);
        }
        
        a.button {
            font-size: clamp(1.2rem, 2.8vw, 1.5rem);
            padding: clamp(1.2rem, 2.8vw, 1.5rem) clamp(2.2rem, 4.5vw, 3.2rem);
            min-width: clamp(160px, 22vw, 240px);
        }
    }
  </style>
</head>
<body>
  <!-- ÂΩ©Â∏¶ÂÆπÂô® -->
  <div class="confetti-container" id="confettiContainer"></div>
  
  <div class="card">
    {% if prize %}
      <div class="congratulations-text" id="congratulationsText">
        <div class="finding-text" id="findingText">‚ú® Finding the perfect gift... ‚ú®</div>
        <h2 id="congratulationsTitle" style="display: none;">üéâ Congratulations! üéâ</h2>
        <div class="prize-name" id="prizeName" style="display: none;">You won: <span id="prizeNameDisplay">{{ prize }}</span></div>
      </div>
      <div class="prize-carousel" id="prizeCarousel">
        <div class="prize-carousel-container" id="prizeCarouselContainer">
          <!-- Images will be loaded by JavaScript -->
        </div>
      </div>
      <div class="prize" style="display: none;">{{ prize }}</div>
    {% else %}
      <h1>No Result</h1>
      <div class="prize" style="color:rgba(255, 248, 220, 0.6);">No Result</div>
    {% endif %}

    <div class="buttons">
        <a class="button"
        href="{% if mode == 'self' %}{{ url_for('main.draw_self') }}
             {% else %}{{ url_for('main.draw_others') }}{% endif %}">
       Draw Again
     </a>
    </div>
  </div>
  
  <script>
    {% if prize %}
    // List of all prize images
    const prizeImages = [
      "{{ url_for('static', filename='prizes/BLESSING_OF_PHASE_SHOP.png') }}",
      "{{ url_for('static', filename='prizes/CURSE_OF_APOLOGIES.png') }}",
      "{{ url_for('static', filename='prizes/CURSE_OF_CHRISTMAS_JOLLY.png') }}",
      "{{ url_for('static', filename='prizes/CURSE_OF_MEMORY_LOSS.png') }}",
      "{{ url_for('static', filename='prizes/CURSE_OF_MINECRAFT_STREAM.png') }}",
      "{{ url_for('static', filename='prizes/CURSE_OF_NICENESS.png') }}",
      "{{ url_for('static', filename='prizes/CURSE_OF_NO_SWEARING.png') }}",
      "{{ url_for('static', filename='prizes/CURSE_OF_PASTA.png') }}",
      "{{ url_for('static', filename='prizes/CURSE_OF_PHASE_COFFEE_BOT.png') }}",
      "{{ url_for('static', filename='prizes/CURSE_OF_REINDEER.png') }}",
      "{{ url_for('static', filename='prizes/CURSE_OF_SIMILISH.png') }}",
      "{{ url_for('static', filename='prizes/CURSSE_OF_RICHMAN_10.png') }}",
      "{{ url_for('static', filename='prizes/Dakimakura.png') }}",
      "{{ url_for('static', filename='prizes/Gift_Card_100_Amazon.png') }}",
      "{{ url_for('static', filename='prizes/Gift_Card_150_Best_Buy.png') }}",
      "{{ url_for('static', filename='prizes/Gift_Card_25_Chipotle.png') }}",
      "{{ url_for('static', filename='prizes/Gift_Card_25_Starbucks.png') }}",
      "{{ url_for('static', filename='prizes/Graphic card.png') }}",
      "{{ url_for('static', filename='prizes/headset.png') }}",
      "{{ url_for('static', filename='prizes/keyboard.png') }}",
      "{{ url_for('static', filename='prizes/laptop.png') }}",
      "{{ url_for('static', filename='prizes/Mic.png') }}",
      "{{ url_for('static', filename='prizes/Mouse.png') }}",
      "{{ url_for('static', filename='prizes/Secret_lap_gaming_chair.png') }}",
      "{{ url_for('static', filename='prizes/stream_deck.png') }}"
    ];
    
    // Shuffle images randomly
    function shuffleArray(array) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }
    
    // Get prize name from template
    const prizeName = "{{ prize }}";
    
    // Find the prize image that matches the prize name
    function findPrizeImageIndex(prizeName, imageSources) {
      if (!prizeName) return -1;
      
      // Normalize prize name for matching
      const normalizedPrizeName = prizeName.toLowerCase().trim();
      
      for (let i = 0; i < imageSources.length; i++) {
        const imagePath = imageSources[i];
        // Extract filename from path and normalize
        const filename = imagePath.split('/').pop().replace('.png', '').toLowerCase();
        
        // Try different matching strategies
        // 1. Direct match (filename equals prize name)
        if (filename === normalizedPrizeName || 
            filename === normalizedPrizeName.replace(/\s+/g, '_') ||
            filename === normalizedPrizeName.replace(/\s+/g, '')) {
          return i;
        }
        
        // 2. Contains match (filename contains prize name or vice versa)
        const filenameNoUnderscore = filename.replace(/_/g, ' ');
        const prizeNameNoSpace = normalizedPrizeName.replace(/\s+/g, '');
        const filenameNoUnderscoreNoSpace = filename.replace(/_/g, '').replace(/\s+/g, '');
        
        if (filename.includes(normalizedPrizeName.replace(/\s+/g, '_')) ||
            filenameNoUnderscore.includes(normalizedPrizeName) ||
            normalizedPrizeName.includes(filenameNoUnderscore) ||
            filenameNoUnderscoreNoSpace.includes(prizeNameNoSpace) ||
            prizeNameNoSpace.includes(filenameNoUnderscoreNoSpace)) {
          return i;
        }
      }
      
      // If no match found, return -1
      return -1;
    }
    
    // Single cycle with random order, but ensure prize image is at the end
    let shuffledImages = shuffleArray(prizeImages);
    const prizeImageIndex = findPrizeImageIndex(prizeName, prizeImages);
    
    // If prize image found, move it to the end
    if (prizeImageIndex !== -1) {
      const prizeImagePath = prizeImages[prizeImageIndex];
      // Remove prize image from shuffled array
      shuffledImages = shuffledImages.filter(img => img !== prizeImagePath);
      // Add it at the end
      shuffledImages.push(prizeImagePath);
    }
    
    const allImages = shuffledImages;
    
    // Preload all images before starting carousel
    // ‰ΩøÁî®Êõ¥Êô∫ËÉΩÁöÑÈ¢ÑÂä†ËΩΩÔºåÂà©Áî®ÊµèËßàÂô®ÁºìÂ≠ò
    function preloadImages(imageSources, callback) {
      let loadedCount = 0;
      const totalImages = imageSources.length;
      
      if (totalImages === 0) {
        callback();
        return;
      }
      
      // Ê£ÄÊü•ÂõæÁâáÊòØÂê¶Â∑≤Âú®ÊµèËßàÂô®ÁºìÂ≠ò‰∏≠
      imageSources.forEach((imageSrc, index) => {
        const img = new Image();
        // ËÆæÁΩÆÁºìÂ≠òÁ≠ñÁï•
        img.crossOrigin = 'anonymous';
        
        // Â∞ùËØï‰ªéÁºìÂ≠òÂä†ËΩΩ
        img.onload = function() {
          loadedCount++;
          if (loadedCount === totalImages) {
            callback();
          }
        };
        img.onerror = function() {
          loadedCount++;
          if (loadedCount === totalImages) {
            callback();
          }
        };
        
        // ‰ΩøÁî®Êó∂Èó¥Êà≥Á°Æ‰øùÁºìÂ≠òÊúâÊïàÊÄßÔºà‰ΩÜÊúçÂä°Á´ØÂ∑≤ËÆæÁΩÆÁºìÂ≠òÂ§¥ÔºåËøôÈáå‰∏ªË¶ÅÊòØËß¶ÂèëÁºìÂ≠òÊ£ÄÊü•Ôºâ
        img.src = imageSrc;
      });
    }
    
    // Create carousel items
    const container = document.getElementById('prizeCarouselContainer');
    allImages.forEach((imageSrc, index) => {
      const item = document.createElement('div');
      item.className = 'prize-carousel-item';
      const img = document.createElement('img');
      img.src = imageSrc;
      img.alt = `Prize ${index + 1}`;
      img.onerror = function() {
        this.style.display = 'none';
      };
      item.appendChild(img);
      container.appendChild(item);
    });
    
    // Wait for all images to load before starting carousel
    preloadImages(allImages, function() {
      // All images loaded, start carousel
      startCarousel();
    });
    
    function startCarousel() {
      // Carousel animation with increasing speed
      let currentIndex = 0;
      const totalItems = allImages.length;
      const carouselItems = document.querySelectorAll('.prize-carousel-item');
      const prizeCarousel = document.getElementById('prizeCarousel');
      let currentInterval = 150; // Start with 150ms
      let carouselInterval;
      const speedUpThreshold = Math.floor(totalItems * 0.7); // Speed up in last 30%
      const finalSpeedThreshold = Math.floor(totalItems * 0.9); // Very fast in last 10%
      
      function moveCarousel() {
        // Remove active class from all items
        carouselItems.forEach(item => {
          item.classList.remove('active');
        });
        
        if (currentIndex < totalItems) {
          // Show current image
          carouselItems[currentIndex].classList.add('active');
          
          // Speed up as we approach the end
          if (currentIndex >= finalSpeedThreshold) {
            // Very fast in last 10%
            if (currentInterval > 50) {
              clearInterval(carouselInterval);
              currentInterval = 50;
              carouselInterval = setInterval(moveCarousel, currentInterval);
            }
          } else if (currentIndex >= speedUpThreshold) {
            // Speed up in last 30%
            if (currentInterval > 80) {
              clearInterval(carouselInterval);
              currentInterval = 80;
              carouselInterval = setInterval(moveCarousel, currentInterval);
            }
          }
          
          currentIndex++;
        } else {
          // After 1 cycle, stop and show the prize image (last image)
          clearInterval(carouselInterval);
          // The last image should be the prize image
          const lastIndex = totalItems - 1;
          
          // Remove active from all items
          carouselItems.forEach(item => {
            item.classList.remove('active', 'winner');
          });
          
          // Add active and winner class to prize image
          carouselItems[lastIndex].classList.add('active', 'winner');
          
          // Create confetti effect
          createConfetti();
          
          // Change text from "Finding..." to "Congratulations!"
          const findingText = document.getElementById('findingText');
          const congratulationsTitle = document.getElementById('congratulationsTitle');
          const prizeName = document.getElementById('prizeName');
          
          if (findingText && congratulationsTitle && prizeName) {
            setTimeout(() => {
              findingText.style.display = 'none';
              congratulationsTitle.style.display = 'block';
              prizeName.style.display = 'block';
            }, 300);
          }
        }
        
        function createConfetti() {
          const confettiContainer = document.getElementById('confettiContainer');
          if (!confettiContainer) return;
          
          // Create more confetti pieces for better effect (24 instead of 18)
          const colors = ['#ffed4e', '#ff8787', '#6dd5ce'];
          
          for (let i = 0; i < 24; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            // Use predefined positions for better distribution
            const positions = [5, 12, 18, 25, 32, 38, 45, 52, 58, 65, 72, 78, 85, 92, 8, 22, 35, 48, 62, 75, 88, 15, 42, 68];
            confetti.style.left = (positions[i] || (Math.random() * 100)) + '%';
            confetti.style.background = colors[i % 3];
            confetti.style.animationDelay = (Math.random() * 0.3) + 's';
            confetti.style.animationDuration = (3.7 + Math.random() * 0.8) + 's';
            confettiContainer.appendChild(confetti);
            
            // Remove confetti after animation
            setTimeout(() => {
              if (confetti.parentNode) {
                confetti.parentNode.removeChild(confetti);
              }
            }, 6000);
          }
        }
      }
      
      // Start carousel
      carouselInterval = setInterval(moveCarousel, currentInterval);
      
      // Initial display - show first image
      if (carouselItems.length > 0) {
        carouselItems[0].classList.add('active');
      }
    }
    {% endif %}
  </script>
</body>
</html>